{"ast":null,"code":"var scmp = require('scmp');\nvar pbkdf2 = require('./pbkdf2');\nvar errors = require('./errors');\n\n// authenticate function needs refactoring - to avoid bugs we wrapped a bit dirty\nmodule.exports = function (user, password, options, cb) {\n  if (cb) {\n    return authenticate(user, password, options, cb);\n  }\n  return new Promise(function (resolve, reject) {\n    authenticate(user, password, options, function (err, user, error) {\n      return err ? reject(err) : resolve({\n        user: user,\n        error: error\n      });\n    });\n  });\n};\nfunction authenticate(user, password, options, cb) {\n  if (options.limitAttempts) {\n    var attemptsInterval = Math.pow(options.interval, Math.log(user.get(options.attemptsField) + 1));\n    var calculatedInterval = attemptsInterval < options.maxInterval ? attemptsInterval : options.maxInterval;\n    if (Date.now() - user.get(options.lastLoginField) < calculatedInterval) {\n      user.set(options.lastLoginField, Date.now());\n      user.save(function (saveErr) {\n        if (saveErr) {\n          return cb(saveErr);\n        }\n        return cb(null, false, new errors.AttemptTooSoonError(options.errorMessages.AttemptTooSoonError));\n      });\n      return;\n    }\n    if (user.get(options.attemptsField) >= options.maxAttempts) {\n      if (options.unlockInterval && Date.now() - user.get(options.lastLoginField) > options.unlockInterval) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save();\n      } else {\n        return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n      }\n    }\n  }\n  if (!user.get(options.saltField)) {\n    return cb(null, false, new errors.NoSaltValueStoredError(options.errorMessages.NoSaltValueStoredError));\n  }\n  pbkdf2(password, user.get(options.saltField), options, function (err, hashBuffer) {\n    if (err) {\n      return cb(err);\n    }\n    if (scmp(hashBuffer, Buffer.from(user.get(options.hashField), options.encoding))) {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save(function (saveErr, user) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n          return cb(null, user);\n        });\n      } else {\n        return cb(null, user);\n      }\n    } else {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, user.get(options.attemptsField) + 1);\n        user.save(function (saveErr) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n          if (user.get(options.attemptsField) >= options.maxAttempts) {\n            return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n          } else {\n            return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n          }\n        });\n      } else {\n        return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n      }\n    }\n  });\n}","map":{"version":3,"names":["scmp","require","pbkdf2","errors","module","exports","user","password","options","cb","authenticate","Promise","resolve","reject","err","error","limitAttempts","attemptsInterval","Math","pow","interval","log","get","attemptsField","calculatedInterval","maxInterval","Date","now","lastLoginField","set","save","saveErr","AttemptTooSoonError","errorMessages","maxAttempts","unlockInterval","TooManyAttemptsError","saltField","NoSaltValueStoredError","hashBuffer","Buffer","from","hashField","encoding","IncorrectPasswordError"],"sources":["/Users/lieo/diabetes/CUT2DMTest/node_modules/passport-local-mongoose/lib/authenticate.js"],"sourcesContent":["const scmp = require('scmp');\n\nconst pbkdf2 = require('./pbkdf2');\nconst errors = require('./errors');\n\n// authenticate function needs refactoring - to avoid bugs we wrapped a bit dirty\nmodule.exports = function (user, password, options, cb) {\n  if (cb) {\n    return authenticate(user, password, options, cb);\n  }\n\n  return new Promise((resolve, reject) => {\n    authenticate(user, password, options, (err, user, error) => (err ? reject(err) : resolve({ user, error })));\n  });\n};\n\nfunction authenticate(user, password, options, cb) {\n  if (options.limitAttempts) {\n    const attemptsInterval = Math.pow(options.interval, Math.log(user.get(options.attemptsField) + 1));\n    const calculatedInterval = attemptsInterval < options.maxInterval ? attemptsInterval : options.maxInterval;\n\n    if (Date.now() - user.get(options.lastLoginField) < calculatedInterval) {\n      user.set(options.lastLoginField, Date.now());\n      user.save(function (saveErr) {\n        if (saveErr) {\n          return cb(saveErr);\n        }\n        return cb(null, false, new errors.AttemptTooSoonError(options.errorMessages.AttemptTooSoonError));\n      });\n      return;\n    }\n\n    if (user.get(options.attemptsField) >= options.maxAttempts) {\n      if (options.unlockInterval && Date.now() - user.get(options.lastLoginField) > options.unlockInterval) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save();\n      } else {\n        return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n      }\n    }\n  }\n\n  if (!user.get(options.saltField)) {\n    return cb(null, false, new errors.NoSaltValueStoredError(options.errorMessages.NoSaltValueStoredError));\n  }\n\n  pbkdf2(password, user.get(options.saltField), options, function (err, hashBuffer) {\n    if (err) {\n      return cb(err);\n    }\n\n    if (scmp(hashBuffer, Buffer.from(user.get(options.hashField), options.encoding))) {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save(function (saveErr, user) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n          return cb(null, user);\n        });\n      } else {\n        return cb(null, user);\n      }\n    } else {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, user.get(options.attemptsField) + 1);\n        user.save(function (saveErr) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n          if (user.get(options.attemptsField) >= options.maxAttempts) {\n            return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n          } else {\n            return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n          }\n        });\n      } else {\n        return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n      }\n    }\n  });\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}